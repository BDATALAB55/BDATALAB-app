---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// --- 設定値 ---
const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const RECURSIVE_API = `https://api.github.com/repos/${GITHUB_REPO}/git/trees/main?recursive=1&t=${Date.now()}`;
const IMAGE_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/output/reports/NBA`;

const token = process.env.GITHUB_TOKEN;



// --- [修正1] ランキングデータの読み込み ---
const rankingFiles = import.meta.glob('../data/rankings/NBA/*.json', { eager: true });
const allRankings = {};
Object.entries(rankingFiles).forEach(([path, content]) => {
  const dateKey = path.split('/').pop().replace('.json', ''); 
  allRankings[dateKey] = content.default || content;
});

let reportGroups = [];
let allPlayerCards = []; // [追加] 選手個別のカード画像リスト用

try {
  const res = await fetch(RECURSIVE_API, {
    headers: token ? { 
      "Authorization": `token ${token}`,
      "Accept": "application/vnd.github.v3+json"
    } : { "Accept": "application/vnd.github.v3+json" }
  });
  const data = await res.json();

  if (data.tree) {
    const allFiles = data.tree.filter(item => 
      item.path.includes('output/reports/NBA/') && 
      item.path.toLowerCase().endsWith('.png')
    );

    allPlayerCards = data.tree.filter(item => 
    item.path.includes('output/players/') &&
    item.path.endsWith('.png')
  );

    const groups = {};
    allFiles.forEach(file => {
      const pathParts = file.path.split('/');
      const nbaIndex = pathParts.indexOf('NBA');
      if (nbaIndex === -1 || pathParts.length <= nbaIndex + 2) return;
      const folderName = pathParts[nbaIndex + 1]; 
      const fileName = pathParts[nbaIndex + 2];
      if (!/^\d+$/.test(folderName)) return;

      const nameParts = fileName.replace('.png', '').split('_');
      
      const fullDate = nameParts[2] || "";
      const gameId = nameParts[3] || "";
      const teamA = nameParts[nameParts.length - 2] || "AWAY";
      const teamB = nameParts[nameParts.length - 1] || "HOME";

      if (!groups[folderName]) {
        groups[folderName] = {
          id: folderName,
          date: `20${folderName.substring(0,2)}.${folderName.substring(2,4)}.${folderName.substring(4,6)}`,
          reports: []
        };
      }
      
      const cardFolderName = `NBA_Cards_${gameId}_${fullDate}`;

      groups[folderName].reports.push({
        path: `${IMAGE_BASE_URL}/${folderName}/${fileName}?t=${Date.now()}`,
        away: teamA, home: teamB,
        link: `/nba-cards?folder=${folderName}/${cardFolderName}`
      });
    });
    reportGroups = Object.values(groups).sort((a, b) => b.id.localeCompare(a.id));
  }
} catch (e) {
  console.error("Fetch Error:", e);
}

const availableDates = Object.keys(allRankings).sort().reverse(); 
const latestDateKey = availableDates[0] || "260124"; // 安全策
const initialData = allRankings[latestDateKey] || { pts: [], reb: [], ast: [] };

const sortRank = (a, b, statKey) => {
  if (b[statKey] !== a[statKey]) return b[statKey] - a[statKey];
  return (a.min || "").localeCompare(b.min || "");
};

const ptsRank10 = (initialData.pts || []).sort((a, b) => sortRank(a, b, 'pts')).slice(0, 10);
const rebRank10 = (initialData.reb || []).sort((a, b) => sortRank(a, b, 'reb')).slice(0, 10);
const astRank10 = (initialData.ast || []).sort((a, b) => sortRank(a, b, 'ast')).slice(0, 10);

const getCardUrl = (cardPathInJson, playerObject) => {
  if (!cardPathInJson || allPlayerCards.length === 0) return "/no-player.png";
  
  // JSON内のパスから Game ID を抽出
  const gameMatch = cardPathInJson.match(/game_(\d+)_/i) || cardPathInJson.match(/Cards_(\d+)_/i);
  const gameId = gameMatch ? gameMatch[1] : null;

  // 検索用の名前を生成
  // 1. 空白をアンダースコアに
  // 2. 特殊文字（'など）は削除せず、大文字化して比較する
  const rawName = playerObject.name ? playerObject.name.trim().toUpperCase() : "";
  const nameWithUnderscore = rawName.replace(/\s+/g, '_');
  
  // 特殊文字を除去したパターンも用意（念のため）
  const nameClean = nameWithUnderscore.replace(/['.]/g, '');

  // 全画像リストから検索
  const realFile = allPlayerCards.find(item => {
    const upperPath = item.path.toUpperCase();
    
    // 同じGameIDのフォルダ内にあるかチェック
    const isSameGame = gameId ? upperPath.includes(gameId) : true;
    
    // 名前が含まれているか（'あり、'なし、両方チェック）
    const matchName = upperPath.includes(nameWithUnderscore) || upperPath.includes(nameClean);
    
    return isSameGame && matchName;
  });

  if (realFile) {
    return `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${encodeURI(realFile.path)}`;
  }

  // フォールバック：GameIDを無視して名前だけで再検索
  const fallbackFile = allPlayerCards.find(item => {
    const p = item.path.toUpperCase();
    return p.includes(nameWithUnderscore) || p.includes(nameClean);
  });

  if (fallbackFile) {
    return `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${encodeURI(fallbackFile.path)}`;
  }

  return "/no-player.png";
};

const teams = [
  { id: 'ATL', color: 'bg-[#E03A3E]' }, { id: 'BOS', color: 'bg-[#007A33]' },
  { id: 'BKN', color: 'bg-black border border-white/20' }, { id: 'CHA', color: 'bg-[#00788C]' },
  { id: 'CHI', color: 'bg-[#CE1141]' }, { id: 'CLE', color: 'bg-[#6F263D]' },
  { id: 'DAL', color: 'bg-[#0053BC]' }, { id: 'DEN', color: 'bg-[#0E2240]' },
  { id: 'DET', color: 'bg-[#1D428A]' }, { id: 'GSW', color: 'bg-[#006BB6]' },
  { id: 'HOU', color: 'bg-[#CE1141]' }, { id: 'IND', color: 'bg-[#002D62]' },
  { id: 'LAC', color: 'bg-[#12173F]' }, { id: 'LAL', color: 'bg-[#552583]' },
  { id: 'MEM', color: 'bg-[#5D76A9]' }, { id: 'MIA', color: 'bg-[#98002E]' },
  { id: 'MIL', color: 'bg-[#00471B]' }, { id: 'MIN', color: 'bg-[#0C2340]' },
  { id: 'NOP', color: 'bg-[#0C2340]' }, { id: 'NYK', color: 'bg-[#F58426]' },
  { id: 'OKC', color: 'bg-[#007AC1]' }, { id: 'ORL', color: 'bg-[#0077C0]' },
  { id: 'PHI', color: 'bg-[#006BB6]' }, { id: 'PHX', color: 'bg-[#1D1160]' },
  { id: 'POR', color: 'bg-[#E03A3E]' }, { id: 'SAC', color: 'bg-[#5A2D81]' },
  { id: 'SAS', color: 'bg-black border border-white/20' }, { id: 'TOR', color: 'bg-[#CE1141]' },
  { id: 'UTA', color: 'bg-[#002B5C]' }, { id: 'WAS', color: 'bg-[#002B5C]' },
];

const today = reportGroups.length > 0 ? reportGroups[0].date : "2026.01.24";
const displayToday = today;
const todayGameCount = reportGroups.length > 0 ? reportGroups[0].reports.length : 0;

const teamChunks = [];
for (let i = 0; i < teams.length; i += 9) {
  teamChunks.push(teams.slice(i, i + 9));
}
---

<Layout title="NBA HOME | B-Data Lab">
  <main class="bg-[#373A36] min-h-screen text-white font-avenir pb-32 overflow-x-hidden relative">
    
    <header class="sticky top-0 z-50 bg-[#373A36]/90 backdrop-blur-md border-b border-white/10">
      <div class="pt-12 pb-6 px-6 max-w-6xl mx-auto w-full">
        <div class="flex items-end justify-between w-full">
          <div class="flex-shrink-0">
            <a href="/nba-home" class="hover:opacity-80 transition-opacity">
              <h1 class="text-5xl md:text-7xl font-black tracking-normal uppercase leading-none">NBA</h1>
            </a>
          </div>
          <div class="flex flex-col items-end text-right space-y-3">
            <h2 class="text-xl md:text-3xl font-black tracking-widest uppercase leading-none">BDATALAB</h2>
            <div class="flex items-center gap-3 md:gap-5">
              <a href="https://x.com/BDataLab5x5" target="_blank" rel="noopener noreferrer" class="group flex items-center gap-1.5 transition-all">
                <div class="w-7 h-7 md:w-8 md:h-8 bg-white/10 rounded-full flex items-center justify-center group-hover:bg-white/20 transition-colors">
                  <svg class="w-3.5 h-3.5 md:w-4 md:h-4 fill-white" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </div>
                <span class="hidden sm:inline text-[10px] font-black tracking-widest uppercase text-white/40 group-hover:text-white transition-colors">X</span>
              </a>
              <div class="h-3 w-[1px] bg-white/20"></div>
              <a href="https://note.com/bdatalab5x5" target="_blank" rel="noopener noreferrer" class="group flex items-center gap-1.5 transition-all">
                <div class="w-7 h-7 md:w-8 md:h-8 bg-white/10 rounded-full flex items-center justify-center group-hover:bg-[#23bb9d] transition-colors">
                   <span class="text-[12px] font-black text-white">n</span>
                </div>
                <span class="text-[10px] font-black tracking-widest lowercase text-white/40 group-hover:text-white transition-colors">note</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6">
      
      <section class="mt-12">
        <div class="flex justify-between items-end mb-8">
          <div>
            <h2 class="text-4xl font-black uppercase tracking-tighter mb-4">GAME REPORT</h2>
            <div class="flex flex-col gap-1">
              <span class="text-blue-500 text-[10px] font-black uppercase tracking-[0.3em]">Latest Update</span>
              <span class="text-white text-[32px] font-bold uppercase leading-none tracking-[0.05em] date-display">{today}</span>
            </div>
          </div>
          <div class="text-right leading-none">
            <span class="text-7xl font-black italic opacity-20 block">{todayGameCount}</span>
            <span class="text-[12px] font-bold opacity-40 uppercase tracking-[0.3em]">Games</span>
          </div>
        </div>

        <div class="flex overflow-x-auto gap-8 no-scrollbar snap-x pb-4">
          {reportGroups.length > 0 ? reportGroups[0].reports.map(r => (
            <div class="flex-none w-[300px] snap-center">
              <div class="rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-black/40 aspect-[3/4.2]">
                <img src={r.path} alt="Report" class="w-full h-full object-cover" />
              </div>
              <div class="mt-6 flex justify-center">
                <a href={r.link} class="inline-flex items-center gap-3 px-6 py-2.5 rounded-full bg-black/40 border-2 border-transparent bg-clip-padding relative active:scale-95 hover:scale-110 transition-transform group overflow-hidden">
                  <div class="absolute inset-0 p-[2px] rounded-full bg-gradient-to-r from-blue-500 via-purple-500 to-red-500 -z-10"></div>
                  <span class="text-[12px] font-black tracking-[0.2em] uppercase text-white">
                    {r.away} <span class="text-[9px] font-medium lowercase tracking-normal mx-1 text-white/50 px-1">vs</span> {r.home}
                  </span>
                </a>
              </div>
            </div>
          )) : <div class="text-gray-500 px-4">No reports found.</div>}
        </div>

        <div class="mt-8 mb-12 flex justify-center">
  <div id="calendar" class="w-full max-w-sm bg-black/20 p-6 rounded-3xl border border-white/5 shadow-2xl">
    </div>
</div>
        
      </section>

      <section class="mt-24">
        <h2 class="text-4xl font-black uppercase tracking-tighter mb-8">TEAM</h2>
        
        <div class="hidden md:grid grid-cols-4 lg:grid-cols-6 gap-2">
          {teams.map(t => (
            <a href={`/nba-team?team=${t.id}`} class="group">
              <div class={`${t.color} aspect-[2/1] rounded-2xl flex items-center justify-center text-3xl font-black tracking-widest transition-all duration-300 group-hover:scale-105 group-hover:brightness-125 group-hover:shadow-[0_0_20px_rgba(255,255,255,0.2)] uppercase`}>
                <span class="group-hover:scale-110 transition-transform">{t.id}</span>
              </div>
            </a>
          ))}
        </div>

        <div class="md:hidden -mx-6">
          <div id="team-carousel" class="flex overflow-x-auto snap-x snap-mandatory no-scrollbar px-6 gap-1.5">
            {teamChunks.map((chunk) => (
              <div class="min-w-full snap-center grid grid-cols-3 gap-1.5">
                {chunk.map(t => (
                  <a href={`/nba-team?team=${t.id}`}>
                    <div class={`${t.color} aspect-square rounded-lg flex items-center justify-center text-xl font-black tracking-widest transition-all active:scale-95 uppercase`}>
                      {t.id}
                    </div>
                  </a>
                ))}
              </div>
            ))}
          </div>
          <div class="flex justify-center gap-1.5 mt-6">
            {teamChunks.map((_, i) => (
              <div class={`h-[2px] rounded-full transition-all duration-300 ${i === 0 ? 'w-6 bg-white' : 'w-2 bg-white/10'}`} data-dot={i}></div>
            ))}
          </div>
        </div>
      </section>

      <section class="mt-32">
        <div class="flex items-baseline gap-4 mb-8">
          <h2 class="text-4xl font-black uppercase tracking-tighter">STANDING</h2>
          <span class="text-[10px] font-bold text-white/40 tracking-widest uppercase">Updated: {today}</span>
        </div>
        <div class="grid grid-cols-2 gap-4 max-w-sm mb-10">
          <button data-tab="standing" data-target="eastern" class="tab-btn bg-white text-black py-4 rounded-xl text-[12px] font-black uppercase tracking-widest text-center hover:scale-105 transition-all">Eastern</button>
          <button data-tab="standing" data-target="western" class="tab-btn bg-black/20 text-white/80 py-4 rounded-xl text-[12px] font-black uppercase tracking-widest text-center hover:bg-white/10 hover:scale-105 transition-all border border-white/5">Western</button>
        </div>
        <div id="standing-container" class="flex overflow-x-auto gap-6 no-scrollbar snap-x pb-4 min-h-[300px]">
          {Array.from({ length: 15 }).map((_, i) => (
            <div class="flex-none w-[220px] snap-center aspect-[3/4] bg-black/40 border border-white/5 rounded-2xl flex flex-col items-center justify-center gap-4 group transition-all hover:bg-black/60">
              <div class="text-[40px] font-black text-white/10 group-hover:text-white/20 transition-colors">{i + 1}</div>
              <span class="text-[10px] font-black tracking-[0.3em] uppercase text-white/30">Coming Soon</span>
            </div>
          ))}
        </div>
      </section>

      <section class="mt-24">
        <h2 class="text-4xl font-black uppercase tracking-tighter mb-4">Today's RANK 10</h2>
        
        <div class="mb-6">
          <span class="text-blue-500 text-[10px] font-black uppercase tracking-[0.3em]">Latest Update</span>
          <br />
          <span class="text-white text-[32px] font-bold uppercase leading-none tracking-[0.05em] rank-date-display">{displayToday}</span>
        </div>

        <div class="flex flex-col md:flex-row md:items-end gap-4 mb-10">
          <div class="flex flex-nowrap gap-2 w-full max-w-sm">
            {['PTS', 'REB', 'AST'].map((stat, i) => (
              <button 
                data-tab="rank" 
                data-target={stat}
                class={`rank-btn flex-1 py-4 rounded-xl text-[12px] font-black tracking-widest uppercase transition-all border border-white/5 
                  ${i === 0 ? 'bg-white text-black' : 'bg-black/20 text-white/80 hover:bg-white/10'}`}
              >
                {stat}
              </button>
            ))}
          </div>
          <p class="text-white text-[10px] font-medium leading-none mb-1 opacity-80">
            ※数値が同じ場合は出場時間が短い選手を上位にしています
          </p>
        </div>

  {['PTS', 'REB', 'AST'].map((statType) => {
    // それぞれのトップ10データを選択
    const rankData = statType === 'PTS' ? ptsRank10 : statType === 'REB' ? rebRank10 : astRank10;
    
    return (
      <div 
        id={`rank-${statType}`} 
        class={`rank-pane ${statType !== 'PTS' ? 'hidden' : ''} flex overflow-x-auto gap-6 no-scrollbar snap-x pb-8 pt-12`}
      >
        {rankData.length > 0 ? rankData.map((player, i) => (
          <div class="rank-card flex-none w-[260px] snap-center">
            <div class="relative group">
              {/* 順位表示 */}
              <div class="absolute -top-11 left-1 z-10 flex items-baseline">
                <span class="text-4xl font-black italic text-white leading-none drop-shadow-lg">{i + 1}</span>
                <span class="text-[10px] font-bold uppercase ml-0.5 text-white/70">
                  {i === 0 ? 'st' : i === 1 ? 'nd' : i === 2 ? 'rd' : 'th'}
                </span>
              </div>

              {/* 選手カード画像 */}
              <div class="relative aspect-[3/4.2] rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-black/40 transition-transform duration-300 group-hover:translate-y-[-4px]">
                <img 
                  src={getCardUrl(player.cardPath, player)} 
                  alt={player.name} 
                  class="w-full h-full object-cover" 
                  loading="lazy"
                />
              </div>

              {/* 選手名ボタン */}
              <div class="mt-4 px-1">
                <a href={`/nba-players?name=${encodeURIComponent(player.name)}`} class="relative group/btn block w-full bg-gradient-to-br from-white/15 to-white/5 border border-white/10 hover:border-white/30 py-3.5 rounded-full transition-all active:scale-95 shadow-xl overflow-hidden">
                  <div class="flex items-center justify-between px-6">
                    <span class="text-[10px] font-black uppercase tracking-[0.2em] text-white/90 truncate mr-2">
                      {player.name}
                    </span>
                    <span class="flex-shrink-0 text-[10px] text-white/40 group-hover/btn:translate-x-1 transition-transform">▶︎</span>
                  </div>
                </a>
              </div>
            </div>
          </div>
        )) : (
          <div class="text-white/20 px-4 py-20 text-center w-full border border-dashed border-white/10 rounded-2xl">
            No ranking data available today.
          </div>
        )}
      </div>
    );
  })}
</section>

    </div>

    <div class="fixed bottom-8 right-8 z-40 pointer-events-none">
      <a href="/" class="pointer-events-auto bg-gray-800 text-white px-8 py-4 rounded-full font-black text-[11px] uppercase tracking-widest shadow-2xl active:scale-95 hover:scale-105 transition-all border border-white/10">Back to Home</a>
    </div>
  </main>
</Layout>

<script is:inline define:vars={{ reportGroups, allRankings, allPlayerCards }}>
  const carousel = document.getElementById('team-carousel');
  const dots = document.querySelectorAll('[data-dot]');
  if (carousel) {
    carousel.addEventListener('scroll', () => {
      const index = Math.round(carousel.scrollLeft / carousel.offsetWidth);
      dots.forEach((dot, i) => {
        if (i === index) {
          dot.classList.add('w-6', 'bg-white');
          dot.classList.remove('w-2', 'bg-white/10');
        } else {
          dot.classList.remove('w-6', 'bg-white');
          dot.classList.add('w-2', 'bg-white/10');
        }
      });
    });
  }

  const initTabs = (btnClassName) => {
    const btns = document.querySelectorAll(`.${btnClassName}`);
    btns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabGroup = btn.getAttribute('data-tab');
        const target = btn.getAttribute('data-target'); // これが重要！

        // ボタンの見た目の切り替え
        document.querySelectorAll(`[data-tab="${tabGroup}"]`).forEach(b => {
          b.classList.remove('bg-white', 'text-black');
          b.classList.add('bg-black/20', 'text-white/80');
        });
        btn.classList.add('bg-white', 'text-black');
        btn.classList.remove('bg-black/20', 'text-white/80');

        // ランキングのパネル表示切り替え
        if (tabGroup === 'rank') {
          // 一旦すべてのパネルを隠す
          document.querySelectorAll('.rank-pane').forEach(pane => pane.classList.add('hidden'));
          // クリックされたターゲット（PTSなど）のパネルだけ表示する
          const targetPane = document.getElementById(`rank-${target}`);
          if (targetPane) targetPane.classList.remove('hidden');
        }
      });
    });
  };
  initTabs('tab-btn');
  initTabs('rank-btn');

  // --- [カレンダー・日付切り替えロジック：B1完全移植版] ---
  const calendarEl = document.getElementById('calendar');
  const availableDates = reportGroups.map(g => g.id); // '260208' 形式のリスト
  
  // 初期表示用の年月（2026年2月）
  let curY = 2026;
  let curM = 1; // 0が1月、1が2月

  function renderCalendar(y, m) {
    if (!calendarEl) return;
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    const firstDay = new Date(y, m, 1).getDay();
    const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
    
    // B1のデザイン・構造を完全再現
    let html = `
      <div class="flex justify-between items-center mb-6 px-2 text-white font-black text-xs tracking-widest">
        <button type="button" class="p-2 hover:text-white/50 transition-colors" id="prevM">←</button>
        <span>${monthNames[m]} ${y}</span>
        <button type="button" class="p-2 hover:text-white/50 transition-colors" id="nextM">→</button>
      </div>
      <div class="grid grid-cols-7 gap-1 text-[9px] text-center text-white/40 mb-4 font-bold uppercase">
        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
      </div>
      <div class="grid grid-cols-7 gap-y-3">`;

    for (let i = 0; i < firstDay; i++) html += '<div></div>';

    for (let d = 1; d <= daysInMonth; d++) {
      const yearSuffix = String(y).slice(-2);
      const dateId = `${yearSuffix}${('0'+(m+1)).slice(-2)}${('0'+d).slice(-2)}`;
      const hasData = availableDates.includes(dateId);
      
      // B1と同一のスタイル：データありはbg-[#2D3A56]
      const activeStyle = hasData 
        ? "bg-[#2D3A56] text-white font-black cursor-pointer shadow-lg scale-110 hover:brightness-125" 
        : "text-white/10 pointer-events-none";
        
      html += `<div class="aspect-square flex items-center justify-center rounded-full text-[12px] transition-all ${activeStyle}" data-date="${dateId}">${d}</div>`;
    }
    calendarEl.innerHTML = html + '</div>';

    // 前後の月への移動
    document.getElementById('prevM').onclick = () => { curM--; if(curM<0){curM=11;curY--} renderCalendar(curY, curM); };
    document.getElementById('nextM').onclick = () => { curM++; if(curM>11){curM=0;curY++} renderCalendar(curY, curM); };
    
    // 日付クリック：レポートとランキングの両方を更新
    calendarEl.querySelectorAll('[data-date]').forEach(el => {
      el.onclick = () => {
        const targetDate = el.getAttribute('data-date');
        updateDashboard(targetDate);
      };
    });
  }

  // データ更新のメイン関数（レポート＋ランキング）
  const updateDashboard = (targetDate) => {
    const group = reportGroups.find(g => g.id === targetDate);
    const rankingData = allRankings[targetDate];

    // 1. 日付表示の更新
    const displayStr = `20${targetDate.substring(0, 2)}.${targetDate.substring(2, 4)}.${targetDate.substring(4, 6)}`;
    document.querySelectorAll('.date-display, .rank-date-display').forEach(d => {
      d.innerText = displayStr;
    });

    // 2. 試合数の更新
    const countEl = document.getElementById('game-count-num');
    if (countEl && group) countEl.innerText = group.reports.length;

    // 3. レポートスライダーの更新
    const slider = document.getElementById('report-slider');
    if (slider && group) {
      slider.innerHTML = group.reports.map(r => `
        <div class="flex-none w-[300px] snap-center">
          <div class="rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-black/40 aspect-[3/4.2]">
            <img src="${r.path}" class="w-full h-full object-cover" loading="lazy" />
          </div>
          <div class="mt-6 px-1">
            <a href="${r.link}" class="relative group/btn block w-full bg-gradient-to-br from-white/15 to-white/5 border border-white/10 hover:border-white/30 py-3.5 rounded-full transition-all active:scale-95 shadow-xl overflow-hidden">
              <div class="flex items-center justify-between px-6">
                <span class="text-[11px] font-black tracking-[0.2em] uppercase text-white/90">
                  ${r.away} <span class="text-[9px] font-medium lowercase tracking-normal mx-1 text-white/40 italic">vs</span> ${r.home}
                </span>
                <span class="flex-shrink-0 text-[10px] text-[#2D3A56] group-hover/btn:translate-x-1 transition-transform duration-300 ease-out">▶︎</span>
              </div>
            </a>
          </div>
        </div>
      `).join('');
      slider.scrollTo({ left: 0, behavior: 'smooth' });
    }

    // 4. ランキングの更新（B1移植：画像検索ロジック付き）
    if (rankingData) {
      ['PTS', 'REB', 'AST'].forEach(statType => {
        const pane = document.getElementById(`rank-${statType}`);
        if (!pane) return;

        const statKey = statType.toLowerCase();
        const sortedData = (rankingData[statKey] || []).sort((a, b) => {
          if (b[statKey] !== a[statKey]) return b[statKey] - a[statKey];
          return (a.min || "").localeCompare(b.min || "");
        }).slice(0, 10);

        pane.innerHTML = sortedData.map((player, i) => {
          // 選手カードURL取得ロジック
          let cardUrl = "/no-player.png";
          const sourcePath = player.cardPath || player.card || "";
          const gameMatch = sourcePath.match(/game_(\d+)_/);
          const gameId = gameMatch ? gameMatch[1] : null;

          if (gameId && allPlayerCards.length > 0) {
            const targetEn = player.name ? player.name.trim().toUpperCase().replace(/\s+/g, '_').replace(/'/g, '') : "";
            const realFile = allPlayerCards.find(item => {
              const upPath = item.path.toUpperCase();
              return upPath.includes(`GAME_${gameId}_`) && targetEn && upPath.includes(targetEn);
            });
            if (realFile) cardUrl = `https://raw.githubusercontent.com/BDATALAB55/BDL-game-player-cards/main/${encodeURI(realFile.path)}`;
          }

          return `
            <div class="rank-card flex-none w-[300px] md:w-[210px] snap-center">
              <div class="relative group">
                <div class="absolute -top-11 left-1 z-10 flex items-baseline">
                  <span class="text-4xl font-black italic text-white leading-none">${i + 1}</span>
                  <span class="text-[10px] font-bold uppercase ml-0.5 text-white/70">${i === 0 ? 'st' : i === 1 ? 'nd' : i === 2 ? 'rd' : 'th'}</span>
                </div>
                <div class="relative aspect-[3/4.2] rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-black/40">
                  <img src="${cardUrl}" alt="${player.name}" class="w-full h-full object-cover" />
                </div>
                <div class="mt-4 px-1">
                  <a href="/nba-players?name=${encodeURIComponent(player.name)}" class="relative group/btn block w-full bg-gradient-to-br from-white/15 to-white/5 border border-white/10 py-3.5 rounded-full transition-all">
                    <div class="flex items-center justify-between px-6">
                      <span class="text-[10px] font-black uppercase tracking-[0.2em] text-white/90 truncate mr-2">${player.name}</span>
                      <span class="text-[10px] text-[#2D3A56]">▶︎</span>
                    </div>
                  </a>
                </div>
              </div>
            </div>`;
        }).join('');
      });
      // モードに合わせてレイアウト再適用（もしapplyViewMode関数がある場合）
      if (typeof applyViewMode === 'function') applyViewMode();
    }
  };

  // 初回実行
  renderCalendar(curY, curM);

</script>

<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>